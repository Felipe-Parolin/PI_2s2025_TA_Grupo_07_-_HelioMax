<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="../../images/icon.png" />
    <title>Cadastro</title>
    <link rel="stylesheet" href="../../styles/login-style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="login-container">
      <div class="login-card">
        <div class="login-header">
          <h1 class="logo">⚡HelioMax</h1>
          <h2>Crie sua conta</h2>
          <p>Preencha seus dados para começar</p>
        </div>

        <form id="registerForm" class="login-form">
          <div class="step step-1 active">
            <div class="form-group">
              <div class="input-wrapper">
                <i class="fas fa-user"></i>
                <input
                  type="text"
                  id="name"
                  name="name"
                  placeholder=" "
                  required
                />
                <label for="name">Nome completo</label>
              </div>
            </div>

            <div class="form-group">
              <div class="input-wrapper">
                <i class="fas fa-id-card"></i>
                <input
                  type="text"
                  id="cpf"
                  name="cpf"
                  placeholder=" "
                  maxlength="14"
                  required
                />
                <label for="cpf">CPF</label>
              </div>
            </div>

            <div class="form-group">
              <div class="input-wrapper">
                <i class="fas fa-envelope"></i>
                <input
                  type="email"
                  id="email"
                  name="email"
                  placeholder=" "
                  required
                />
                <label for="email">E-mail</label>
              </div>
              <div id="emailWarning" class="email-warning">
                ❌ Este e-mail já está cadastrado.
              </div>
            </div>

            <div class="form-group">
              <div class="input-wrapper">
                <i class="fas fa-lock"></i>
                <input
                  type="password"
                  id="password"
                  name="password"
                  placeholder=" "
                  required
                  minlength="6"
                />
                <label for="password">Senha</label>
              </div>
            </div>

            <div class="form-group">
              <div class="input-wrapper">
                <i class="fas fa-lock"></i>
                <input
                  type="password"
                  id="confirmPassword"
                  name="confirmPassword"
                  placeholder=" "
                  required
                  minlength="6"
                />
                <label for="confirmPassword">Confirmar senha</label>
              </div>
            </div>

            <div class="step-buttons">
              <button type="button" class="login-button" id="nextStep">
                Próximo <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>

          <div class="step step-2">
            <div class="form-group">
              <div class="input-wrapper">
                <i class="fas fa-map-pin"></i>
                <input
                  type="text"
                  id="cep"
                  name="cep"
                  placeholder=" "
                  maxlength="9"
                  required
                />
                <label for="cep">CEP</label>
              </div>
              <div id="loadingCep" class="loading-container">
                <div class="spinner"></div>
                <span>Buscando endereço...</span>
              </div>
            </div>

            <div class="form-group">
              <div class="input-wrapper">
                <i class="fas fa-road"></i>
                <input
                  type="text"
                  id="street"
                  name="street"
                  placeholder=" "
                  required
                />
                <label for="street">Rua</label>
              </div>
            </div>

            <div class="form-group">
              <div class="input-wrapper">
                <i class="fas fa-hashtag"></i>
                <input
                  type="text"
                  id="number"
                  name="number"
                  placeholder=" "
                  required
                />
                <label for="number">Número</label>
              </div>
            </div>

            <div class="form-group">
              <div class="input-wrapper">
                <i class="fas fa-home"></i>
                <input
                  type="text"
                  id="complement"
                  name="complement"
                  placeholder=" "
                />
                <label for="complement">Complemento</label>
              </div>
            </div>

            <div class="form-group">
              <div class="input-wrapper">
                <i class="fas fa-city"></i>
                <input
                  type="text"
                  id="neighborhood"
                  name="neighborhood"
                  placeholder=" "
                  required
                />
                <label for="neighborhood">Bairro</label>
              </div>
            </div>

            <div class="form-group">
              <div class="input-wrapper">
                <i class="fas fa-building"></i>
                <input
                  type="text"
                  id="city"
                  name="city"
                  placeholder=" "
                  required
                />
                <label for="city">Cidade</label>
              </div>
            </div>

            <div class="form-group">
              <div class="input-wrapper">
                <i class="fas fa-flag"></i>
                <input
                  type="text"
                  id="state"
                  name="state"
                  placeholder=" "
                  maxlength="2"
                  required
                />
                <label for="state">Estado</label>
              </div>
            </div>

            <div class="step-buttons">
              <button type="button" class="login-button" id="prevStep">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <button type="submit" class="login-button" id="submitBtn">
                Cadastrar <i class="fas fa-user-plus"></i>
              </button>
            </div>
          </div>

          <div class="signup-link">
            <p>Já tem conta? <a href="../PHP/login.php">Entrar</a></p>
          </div>
        </form>
      </div>
    </div>

    <script>
      const step1 = document.querySelector(".step-1");
      const step2 = document.querySelector(".step-2");
      const nextBtn = document.getElementById("nextStep");
      const prevBtn = document.getElementById("prevStep");
      const cpfInput = document.getElementById("cpf");
      const cepInput = document.getElementById("cep");
      const emailInput = document.getElementById("email");
      const emailWarning = document.getElementById("emailWarning");
      const loadingCep = document.getElementById("loadingCep");
      const logo = document.querySelector(".logo");
      let emailValido = true;

      function handleLogoRedirect(e) {
        e.preventDefault();
        window.location.href = "landpage.html";
      }

      logo.addEventListener("click", handleLogoRedirect);

      cpfInput.addEventListener("input", () => {
        let value = cpfInput.value.replace(/\D/g, "");
        value = value.replace(/(\d{3})(\d)/, "$1.$2");
        value = value.replace(/(\d{3})(\d)/, "$1.$2");
        value = value.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
        cpfInput.value = value;
      });

      emailInput.addEventListener("blur", async () => {
        const email = emailInput.value.trim();
        if (!email) return;

        try {
          const response = await fetch("../PHP/verificarEmail.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email }),
          });
          const result = await response.json();

          if (result.exists) {
            emailWarning.classList.add("show");
            emailValido = false;
          } else {
            emailWarning.classList.remove("show");
            emailValido = true;
          }
        } catch {
          console.error("Erro ao verificar e-mail");
        }
      });

      cepInput.addEventListener("input", () => {
        let value = cepInput.value.replace(/\D/g, "");
        if (value.length > 5) value = value.replace(/(\d{5})(\d)/, "$1-$2");
        cepInput.value = value;
        if (value.length === 9) buscarCEP(value);
      });

      async function buscarCEP(cep) {
        const cleanCep = cep.replace("-", "");
        loadingCep.classList.add("show");

        try {
          const response = await fetch(
            `https://viacep.com.br/ws/${cleanCep}/json/`
          );
          const data = await response.json();
          loadingCep.classList.remove("show");

          if (data.erro) {
            alert("CEP não encontrado!");
            return;
          }

          document.getElementById("street").value = data.logouro || "";
          document.getElementById("neighborhood").value = data.bairro || "";
          document.getElementById("city").value = data.localidade || "";
          document.getElementById("state").value = data.uf || "";
        } catch {
          loadingCep.classList.remove("show");
          alert("Erro ao buscar CEP!");
        }
      }

      nextBtn.addEventListener("click", () => {
        const password = document.getElementById("password").value.trim();
        const confirmPassword = document
          .getElementById("confirmPassword")
          .value.trim();

        if (!emailValido) {
          alert("Esse e-mail já está cadastrado!");
          return;
        }

        if (
          document.getElementById("name").value.trim() &&
          document.getElementById("cpf").value.trim() &&
          document.getElementById("email").value.trim() &&
          password &&
          confirmPassword
        ) {
          if (password !== confirmPassword) {
            alert("As senhas não coincidem!");
            return;
          }

          if (password.length < 6) {
            alert("A senha deve ter pelo menos 6 caracteres!");
            return;
          }

          step1.classList.remove("active");
          step2.classList.add("active");
        } else {
          alert("Preencha todos os campos antes de continuar.");
        }
      });

      prevBtn.addEventListener("click", () => {
        step2.classList.remove("active");
        step1.classList.add("active");
      });

      document
        .getElementById("registerForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!emailValido) {
            alert("Corrija o e-mail antes de continuar.");
            return;
          }

          const data = {
            name: document.getElementById("name").value.trim(),
            cpf: document.getElementById("cpf").value.trim(),
            email: document.getElementById("email").value.trim(),
            password: document.getElementById("password").value,
            cep: document.getElementById("cep").value.trim(),
            street: document.getElementById("street").value.trim(),
            number: document.getElementById("number").value.trim(),
            complement: document.getElementById("complement").value.trim(),
            neighborhood: document.getElementById("neighborhood").value.trim(),
            city: document.getElementById("city").value.trim(),
            state: document.getElementById("state").value.trim().toUpperCase(),
          };

          try {
            const response = await fetch("../PHP/api_register.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });

            const result = await response.json();
            if (result.success) {
              alert("Usuário cadastrado com sucesso!");
              window.location.href = "../PHP/login.php";
            } else {
              alert(result.message);
            }
          } catch {
            alert("Erro ao cadastrar usuário!");
          }
        });
    </script>
  </body>
</html>