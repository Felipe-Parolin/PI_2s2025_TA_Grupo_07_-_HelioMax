<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro - HelioMax</title>
  <link rel="stylesheet" href="login-style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .step { display: none; animation: fadeIn 0.4s ease; }
    .step.active { display: block; }
    @keyframes fadeIn { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }
    .step-buttons { display: flex; justify-content: space-between; margin-top: 1rem; gap: 10px; }
    .step-buttons button { flex: 1; }
    .loading-container {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #444;
      font-size: 0.9rem;
      margin-top: 0.3rem;
      animation: fadeIn 0.3s ease;
    }
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #ccc;
      border-top-color: #007bff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .email-warning { color: red; font-size: 0.9rem; margin-top: 4px; display: none; }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-card">
      <div class="login-header">
        <h1 class="logo">⚡HelioMax</h1>
        <h2>Crie sua conta</h2>
        <p>Preencha seus dados para começar</p>
      </div>

      <form id="registerForm">
        <!-- ETAPA 1: DADOS PESSOAIS -->
        <div class="step step-1 active">
          <div class="form-group">
            <label for="name">Nome completo</label>
            <div class="input-wrapper">
              <i class="fas fa-user"></i>
              <input type="text" id="name" name="name" placeholder="Seu nome completo" required>
            </div>
          </div>

          <div class="form-group">
            <label for="cpf">CPF</label>
            <div class="input-wrapper">
              <i class="fas fa-id-card"></i>
              <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" maxlength="14" required>
            </div>
          </div>

          <div class="form-group">
            <label for="email">E-mail</label>
            <div class="input-wrapper">
              <i class="fas fa-envelope"></i>
              <input type="email" id="email" name="email" placeholder="seu@email.com" required>
            </div>
            <div id="emailWarning" class="email-warning">❌ Este e-mail já está cadastrado.</div>
          </div>

          <div class="form-group">
            <label for="password">Senha</label>
            <div class="input-wrapper">
              <i class="fas fa-lock"></i>
              <input type="password" id="password" name="password" placeholder="Crie uma senha" required minlength="6">
            </div>
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirmar senha</label>
            <div class="input-wrapper">
              <i class="fas fa-lock"></i>
              <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Repita sua senha" required minlength="6">
            </div>
          </div>

          <div class="step-buttons">
            <button type="button" class="login-button" id="nextStep">
              Próximo <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <!-- ETAPA 2: ENDEREÇO -->
        <div class="step step-2">
          <div class="form-group">
            <label for="cep">CEP</label>
            <div class="input-wrapper">
              <i class="fas fa-map-pin"></i>
              <input type="text" id="cep" name="cep" placeholder="00000-000" maxlength="9" required>
            </div>
            <div id="loadingCep" class="loading-container" style="display:none;">
              <div class="spinner"></div>
              <span>Buscando endereço...</span>
            </div>
          </div>

          <div class="form-group">
            <label for="street">Rua</label>
            <div class="input-wrapper">
              <i class="fas fa-road"></i>
              <input type="text" id="street" name="street" placeholder="Nome da rua" required>
            </div>
          </div>

          <div class="form-group">
            <label for="number">Número</label>
            <div class="input-wrapper">
              <i class="fas fa-hashtag"></i>
              <input type="text" id="number" name="number" placeholder="Número" required>
            </div>
          </div>

          <div class="form-group">
            <label for="neighborhood">Bairro</label>
            <div class="input-wrapper">
              <i class="fas fa-city"></i>
              <input type="text" id="neighborhood" name="neighborhood" placeholder="Bairro" required>
            </div>
          </div>

          <div class="form-group">
            <label for="city">Cidade</label>
            <div class="input-wrapper">
              <i class="fas fa-building"></i>
              <input type="text" id="city" name="city" placeholder="Cidade" required>
            </div>
          </div>

          <div class="form-group">
            <label for="state">Estado</label>
            <div class="input-wrapper">
              <i class="fas fa-flag"></i>
              <input type="text" id="state" name="state" placeholder="UF" maxlength="2" required>
            </div>
          </div>

          <div class="step-buttons">
            <button type="button" class="login-button" id="prevStep">
              <i class="fas fa-arrow-left"></i> Voltar
            </button>
            <button type="submit" class="login-button" id="submitBtn">
              Cadastrar <i class="fas fa-user-plus"></i>
            </button>
          </div>
        </div>

        <div class="signup-link">
          <p>Já tem conta? <a href="login.html">Entrar</a></p>
        </div>
      </form>
    </div>
  </div>

  <script>
    const step1 = document.querySelector(".step-1");
    const step2 = document.querySelector(".step-2");
    const nextBtn = document.getElementById("nextStep");
    const prevBtn = document.getElementById("prevStep");
    const cpfInput = document.getElementById("cpf");
    const cepInput = document.getElementById("cep");
    const emailInput = document.getElementById("email");
    const emailWarning = document.getElementById("emailWarning");
    const loadingCep = document.getElementById("loadingCep");
    let emailValido = true;

    // Máscara CPF
    cpfInput.addEventListener("input", () => {
      let value = cpfInput.value.replace(/\D/g, "");
      value = value.replace(/(\d{3})(\d)/, "$1.$2");
      value = value.replace(/(\d{3})(\d)/, "$1.$2");
      value = value.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
      cpfInput.value = value;
    });

    // Verifica e-mail duplicado
    emailInput.addEventListener("blur", async () => {
      const email = emailInput.value.trim();
      if (!email) return;

      try {
        const response = await fetch("verificarEmail.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email })
        });
        const result = await response.json();

        if (result.exists) {
          emailWarning.style.display = "block";
          emailValido = false;
        } else {
          emailWarning.style.display = "none";
          emailValido = true;
        }
      } catch {
        console.error("Erro ao verificar e-mail");
      }
    });

    // Máscara e busca CEP com loading
    cepInput.addEventListener("input", () => {
      let value = cepInput.value.replace(/\D/g, "");
      if (value.length > 5) value = value.replace(/(\d{5})(\d)/, "$1-$2");
      cepInput.value = value;
      if (value.length === 9) buscarCEP(value);
    });

    async function buscarCEP(cep) {
      const cleanCep = cep.replace("-", "");
      loadingCep.style.display = "flex";

      try {
        const response = await fetch(`https://viacep.com.br/ws/${cleanCep}/json/`);
        const data = await response.json();
        loadingCep.style.display = "none";

        if (data.erro) {
          alert("CEP não encontrado!");
          return;
        }

        document.getElementById("street").value = data.logradouro || "";
        document.getElementById("neighborhood").value = data.bairro || "";
        document.getElementById("city").value = data.localidade || "";
        document.getElementById("state").value = data.uf || "";

      } catch {
        loadingCep.style.display = "none";
        alert("Erro ao buscar CEP!");
      }
    }

    // Trocar etapa
    nextBtn.addEventListener("click", () => {
      const password = document.getElementById("password").value.trim();
      const confirmPassword = document.getElementById("confirmPassword").value.trim();

      if (!emailValido) {
        alert("Esse e-mail já está cadastrado!");
        return;
      }

      if (
        document.getElementById("name").value.trim() &&
        document.getElementById("cpf").value.trim() &&
        document.getElementById("email").value.trim() &&
        password &&
        confirmPassword
      ) {
        if (password !== confirmPassword) {
          alert("As senhas não coincidem!");
          return;
        }

        if (password.length < 6) {
          alert("A senha deve ter pelo menos 6 caracteres!");
          return;
        }

        step1.classList.remove("active");
        step2.classList.add("active");
      } else {
        alert("Preencha todos os campos antes de continuar.");
      }
    });

    prevBtn.addEventListener("click", () => {
      step2.classList.remove("active");
      step1.classList.add("active");
    });

    // Envio final
    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!emailValido) {
        alert("Corrija o e-mail antes de continuar.");
        return;
      }

      const data = {
        name: document.getElementById("name").value.trim(),
        cpf: document.getElementById("cpf").value.trim(),
        email: document.getElementById("email").value.trim(),
        password: document.getElementById("password").value,
        cep: document.getElementById("cep").value.trim(),
        street: document.getElementById("street").value.trim(),
        number: document.getElementById("number").value.trim(),
        neighborhood: document.getElementById("neighborhood").value.trim(),
        city: document.getElementById("city").value.trim(),
        state: document.getElementById("state").value.trim().toUpperCase(),
      };

      try {
        const response = await fetch("register.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
          alert("Usuário cadastrado com sucesso!");
          window.location.href = "login.html";
        } else {
          alert(result.message);
        }
      } catch {
        alert("Erro ao cadastrar usuário!");
      }
    });
  </script>
</body>
</html>
